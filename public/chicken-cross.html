<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>Chicken Cross - Rainbet</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
<style>
@font-face{font-family:'Literata';src:url('chicken-cross_files/0c21ba7ace_904be59b21bd51cb-s.p.woff2') format('woff2');font-weight:200 900;font-display:swap}
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
html,body{width:100%;height:100%;overflow:hidden;background:#0e1225;font-family:'Literata',Georgia,serif;color:#e8e5ff}
body{display:flex;flex-direction:column}

/* GAME HEADER - matches screenshot exactly */
.game-top-bar{height:44px;min-height:44px;background:#1a2040;display:flex;align-items:center;padding:0 16px;gap:10px;border-bottom:1px solid rgba(232,229,255,0.06)}
.game-top-bar .info-btn{width:28px;height:28px;border-radius:50%;border:1.5px solid #5B628C;background:none;color:#5B628C;font-size:13px;font-weight:700;cursor:pointer;display:flex;align-items:center;justify-content:center;font-family:serif}
.game-top-bar .info-btn:hover{border-color:#b9c0e5;color:#b9c0e5}
.game-top-bar .game-icon{font-size:18px;margin-left:4px}
.game-top-bar .game-title{font-size:14px;font-weight:700;color:#fff}
.game-top-bar .spacer{flex:1}
.fair-play-btn{display:flex;align-items:center;gap:6px;background:none;border:none;color:#5B628C;font-size:13px;font-weight:600;cursor:pointer;font-family:inherit;padding:6px 10px;border-radius:6px;transition:color .15s}
.fair-play-btn:hover{color:#b9c0e5}
.fair-play-btn svg{flex-shrink:0}

/* CANVAS AREA */
.game-area{flex:1;position:relative;background:#11172b;overflow:hidden}
.game-area canvas{width:100%!important;height:100%!important;display:block}

/* WIN OVERLAY */
.win-overlay{position:absolute;top:0;left:0;right:0;bottom:0;display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:20;pointer-events:none;opacity:0;transition:opacity .3s}
.win-overlay.show{opacity:1}
.win-overlay .win-bg{position:absolute;inset:0;background:rgba(17,22,40,.85)}
.win-overlay .win-content{position:relative;text-align:center}
.win-overlay .win-label{font-size:16px;color:#b9c0e5;margin-bottom:4px}
.win-overlay .win-amount{font-size:48px;font-weight:800;background:linear-gradient(180deg,#7DD934,#3cb32e);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}
.win-overlay .win-mult{font-size:20px;color:#7DD934;font-weight:700;margin-top:4px}

/* BET OVERLAY - positioned at bottom of canvas like real game */
.bet-overlay{position:absolute;bottom:0;left:50%;transform:translateX(-50%);z-index:15;display:flex;align-items:flex-end;gap:12px;padding:16px;width:100%;max-width:750px;pointer-events:none}
.bet-overlay>*{pointer-events:auto}
.bet-col-l,.bet-col-r{width:180px;display:flex;flex-direction:column;gap:6px;flex-shrink:0}
.bet-col-c{flex:1;display:flex;flex-direction:column;gap:4px;min-width:200px}
.input-label{font-size:11px;color:#5B628C;text-transform:uppercase;font-weight:600;letter-spacing:.5px;margin-bottom:2px}
.input-row{display:flex;align-items:center;gap:4px;background:radial-gradient(ellipse at center,#262C51,#1D2341);border:1px solid #282F58;border-radius:8px;padding:0 4px;height:38px}
.input-row:focus-within{border-color:#2099FF}
.input-row input{flex:1;background:transparent;border:none;color:#fff;font-size:13px;font-family:inherit;outline:none;padding:0 6px;min-width:0}
.input-row input::placeholder{color:#4a5180}
.input-row .dollar{color:#5B628C;font-size:13px;font-weight:600;padding-left:6px}
.input-btn{background:#212747;border:1px solid #33395C;color:#b9c0e5;border-radius:4px;padding:2px 8px;font-size:11px;font-weight:600;cursor:pointer;font-family:inherit;transition:all .15s}
.input-btn:hover{background:#2A2F52}

/* DIFFICULTY DROPDOWN */
.diff-select{position:relative}
.diff-trigger{width:100%;background:radial-gradient(ellipse at center,#262C51,#1D2341);border:1px solid #282F58;border-radius:8px;padding:0 10px;color:#fff;font-size:13px;font-family:inherit;cursor:pointer;display:flex;align-items:center;justify-content:space-between;height:38px}
.diff-trigger:hover{border-color:#33395c}
.diff-trigger .arrow{font-size:10px;color:#5B628C;transition:transform .2s}
.diff-trigger .arrow.open{transform:rotate(180deg)}
.diff-dropdown{position:absolute;bottom:100%;left:0;right:0;background:#1a1f3b;border:1px solid #33395c;border-radius:8px;margin-bottom:4px;overflow:hidden;display:none;z-index:100}
.diff-dropdown.show{display:block}
.diff-option{padding:10px 12px;font-size:13px;color:#b9c0e5;cursor:pointer}
.diff-option:hover{background:#212747}
.diff-option.active{background:#313963;color:#fff}

/* ACTION BUTTONS - stacked like real game */
.action-btn{width:100%;height:46px;border:none;border-radius:10px;font-size:16px;font-weight:700;cursor:pointer;font-family:inherit;transition:filter .15s;text-transform:capitalize}
.action-btn:hover{filter:brightness(1.1)}
.action-btn:active{filter:brightness(.95)}
.action-btn:disabled{opacity:.5;cursor:not-allowed;filter:none}
.action-btn.bet{background:#0077DB;color:#fff;border:1px solid #3C9DEE}
.action-btn.cross{background:linear-gradient(180deg,#8b4dff,#6425e6);color:#fff;border:1px solid #9a63ff}
.action-btn.cashout{background:linear-gradient(180deg,#7DD934,#5FB820);color:#fff;border:1px solid #9AEF52}

/* INFO ROW between cross and cashout */
.info-row{display:flex;align-items:center;justify-content:space-between;background:radial-gradient(ellipse at center,#262C51,#1D2341);border:1px solid #282F58;border-radius:8px;padding:6px 14px;font-size:13px}
.info-row .label{color:#b9c0e5}
.info-row .val{color:#7DD934;font-weight:700}
.info-row .val.zero{color:#b9c0e5}

/* FOOTER BAR - matches screenshot */
.game-footer{height:48px;min-height:48px;background:#1a2040;border-top:1px solid rgba(232,229,255,0.06);display:flex;align-items:center;padding:0 16px}
.footer-left{display:flex;align-items:center;gap:4px}
.footer-icon{width:34px;height:34px;border-radius:6px;background:none;border:none;color:#5B628C;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:color .15s}
.footer-icon:hover{color:#b9c0e5}
.footer-icon svg{width:18px;height:18px}
.footer-center{flex:1;display:flex;justify-content:center;align-items:center}
.footer-logo{color:#3a4070;font-size:16px;font-weight:700;font-style:italic;letter-spacing:1px;user-select:none}
.footer-right{display:flex;align-items:center;gap:2px}
.footer-tab{background:none;border:none;color:#5B628C;font-size:13px;font-weight:600;cursor:pointer;padding:6px 12px;font-family:inherit;border-radius:6px;transition:color .15s}
.footer-tab.active{color:#fff}
.footer-tab:hover:not(.active){color:#b9c0e5}

/* CURRENT ROUND / NEXT MULT on right side of overlay */
.side-info{display:flex;flex-direction:column;gap:4px}
.side-info-box{background:radial-gradient(ellipse at center,#262C51,#1D2341);border:1px solid #282F58;border-radius:8px;padding:6px 10px;text-align:center}
.side-info-box .si-label{font-size:9px;color:#5B628C;text-transform:uppercase;font-weight:600;letter-spacing:.3px}
.side-info-box .si-val{font-size:14px;font-weight:700;color:#b9c0e5;margin-top:1px}
.side-info-box .si-val.green{color:#7DD934}

@media(max-width:600px){
  .bet-overlay{flex-direction:column;align-items:stretch;gap:8px;padding:10px}
  .bet-col-l,.bet-col-r{width:100%;flex-direction:row;gap:8px}
  .bet-col-l>*,.bet-col-r>*{flex:1}
}
::-webkit-scrollbar{width:5px}
::-webkit-scrollbar-track{background:#111628}
::-webkit-scrollbar-thumb{background:#33395c;border-radius:3px}
</style>
</head>
<body>

<!-- GAME HEADER -->
<div class="game-top-bar">
  <button class="info-btn" title="Info">i</button>
  <span class="game-icon">üêî</span>
  <span class="game-title">Chicken Cross</span>
  <span class="spacer"></span>
  <button class="fair-play-btn" onclick="showFairness()">
    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 11.08V12a10 10 0 11-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>
    Fair Play
  </button>
</div>

<!-- GAME CANVAS -->
<div class="game-area" id="gameCanvas">
  <div class="win-overlay" id="winOverlay">
    <div class="win-bg"></div>
    <div class="win-content">
      <div class="win-label">YOU WON</div>
      <div class="win-amount" id="winAmount">$0.00</div>
      <div class="win-mult" id="winMult">0.00x</div>
    </div>
  </div>

  <!-- BET CONTROLS OVERLAY -->
  <div class="bet-overlay">
    <div class="bet-col-l">
      <div>
        <div class="input-label">Bet Amount</div>
        <div class="input-row">
          <span class="dollar">$</span>
          <input type="number" id="betAmount" value="0.00" min="0.01" step="0.01" placeholder="0.00">
          <button class="input-btn" onclick="multBet(0.5)">¬Ω</button>
          <button class="input-btn" onclick="multBet(2)">2√ó</button>
        </div>
      </div>
    </div>
    <div class="bet-col-c">
      <button class="action-btn cross" id="crossBtn" onclick="onCross()" style="display:none">Cross</button>
      <div class="info-row" id="infoRow">
        <span class="label" id="infoLabel">Enter Bet Amount For Real Play</span>
        <span class="val zero" id="infoVal">1.09x</span>
      </div>
      <button class="action-btn cashout" id="cashoutBtn" onclick="cashOut()" style="display:none">Cash Out</button>
      <button class="action-btn bet" id="betBtn" onclick="startGame()" style="display:none">Bet</button>
    </div>
    <div class="bet-col-r">
      <div>
        <div class="input-label">Risk</div>
        <div class="diff-select" id="difficultySelect">
          <button class="diff-trigger" id="diffTrigger" onclick="toggleDifficulty()">
            <span id="diffLabel">Easy</span>
            <span class="arrow" id="diffArrow">‚ñº</span>
          </button>
          <div class="diff-dropdown" id="diffDropdown">
            <div class="diff-option active" data-diff="easy" onclick="setDifficulty('easy')">Easy</div>
            <div class="diff-option" data-diff="medium" onclick="setDifficulty('medium')">Medium</div>
            <div class="diff-option" data-diff="hard" onclick="setDifficulty('hard')">Hard</div>
            <div class="diff-option" data-diff="expert" onclick="setDifficulty('expert')">Expert</div>
          </div>
        </div>
      </div>
      <div class="side-info">
        <div class="side-info-box">
          <div class="si-label">Current Round</div>
          <div class="si-val" id="roundDisplay">0 / 24</div>
        </div>
        <div class="side-info-box">
          <div class="si-label">Next Multiplier</div>
          <div class="si-val green" id="nextMultDisplay">1.04x</div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- FOOTER -->
<div class="game-footer">
  <div class="footer-left">
    <button class="footer-icon" id="soundBtn" onclick="toggleSound()" title="Sound">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"/><path d="M19.07 4.93a10 10 0 010 14.14M15.54 8.46a5 5 0 010 7.07"/></svg>
    </button>
    <button class="footer-icon" onclick="alert('Hotkeys:\n\nSpace/Enter = Cross\nC / Escape = Cash out\n¬Ω / 2√ó = Adjust bet')" title="Hotkeys">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="2" y="4" width="20" height="16" rx="2"/><path d="M6 8h.01M10 8h.01M14 8h.01M18 8h.01M8 12h8M6 16h12"/></svg>
    </button>
    <button class="footer-icon" onclick="toggleFullscreen()" title="Fullscreen">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="15 3 21 3 21 9"/><polyline points="9 21 3 21 3 15"/><line x1="21" y1="3" x2="14" y2="10"/><line x1="3" y1="21" x2="10" y2="14"/></svg>
    </button>
  </div>
  <div class="footer-center">
    <span class="footer-logo">Rainbet</span>
  </div>
  <div class="footer-right">
    <button class="footer-tab active">Manual</button>
    <button class="footer-tab">Auto</button>
  </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/pixi.js/7.4.2/pixi.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.5/gsap.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.5/PixiPlugin.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.5/MotionPathPlugin.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/howler/2.2.4/howler.min.js"></script>
<script>
gsap.registerPlugin(PixiPlugin, MotionPathPlugin);
PixiPlugin.registerPIXI(PIXI);

const ASSET = 'chicken-cross_files/assets/';
const DIFF = {
  easy:   { lanes:24, factor:1,  label:'Easy' },
  medium: { lanes:22, factor:3,  label:'Medium' },
  hard:   { lanes:20, factor:5,  label:'Hard' },
  expert: { lanes:15, factor:10, label:'Expert' }
};
const BG=0x11172B, LANE_W=170, START_W=180, END_W=180, CHK_SCALE=0.12;

let balance=5293, diff='easy', state='idle', round=0, bet=0, mult=0, results=[];
let soundEnabled=true, cheatCharges=0;
let app, scene, lanesC, chicken, tex={}, snd={}, lanes=[], parts={}, animating=false;
const vehicles=[];

function calcMult(r,f){if(r<=0)return 0;let n=1;for(let i=0;i<r;i++)n*=(25-f-i)/(25-i);return Math.max(1,parseFloat((0.96/n).toFixed(2)))}
function multTable(d){const f=DIFF[d].factor,n=DIFF[d].lanes,t=[];for(let r=1;r<=n;r++)t.push(calcMult(r,f));return t}
function genResults(d){const f=DIFF[d].factor,n=DIFF[d].lanes,r=[];for(let i=1;i<=n;i++){const m=calcMult(i,f);r.push(Math.random()<(0.96/m))}return r}

function loadSounds(){
  const a=ASSET+'audio/',files={chirp:'chirp-1.mp3',win:'chicken-win.mp3',lose:'chicken-lose.mp3',carHit1:'car-hit-1.mp3',carHit2:'car-hit-2.mp3',carStop:'car-stopping.mp3',grate:'grate-opening.mp3',bi0:'barrier-impact-0.mp3',bi1:'barrier-impact-1.mp3',bi2:'barrier-impact-2.mp3',tc1l:'traffic-car-1-loud.mp3',tc2l:'traffic-car-2-loud.mp3',tc1q:'traffic-car-1-quite.mp3',tc2q:'traffic-car-2-quite.mp3',tt1l:'traffic-truck-1-loud.mp3',tt2l:'traffic-truck-2-loud.mp3',tp:'traffic-police-2-loud.mp3'};
  for(const[k,f]of Object.entries(files))snd[k]=new Howl({src:[a+f],volume:0.35,preload:true});
}
function play(k){if(soundEnabled&&snd[k])snd[k].play()}

async function init(){
  const el=document.getElementById('gameCanvas');
  app=new PIXI.Application({width:el.clientWidth||800,height:el.clientHeight||500,autoDensity:true,resolution:Math.min(devicePixelRatio||1,2),antialias:true,backgroundColor:BG});
  el.insertBefore(app.view,el.firstChild);
  window.addEventListener('resize',()=>{app.renderer.resize(el.clientWidth,el.clientHeight);layout()});
  await loadSheets();loadSounds();buildScene();layout();
}

async function loadSheets(){
  const names=['chicken-body-content','chicken-faces','chicken-cross-cars','chicken-background-content-1','chicken-background-content-2','blocker'];
  for(const n of names){try{const r=await fetch(ASSET+'images/'+n+'.json');const d=await r.json();d.meta.image=ASSET+'images/'+d.meta.image;const s=new PIXI.Spritesheet(PIXI.BaseTexture.from(d.meta.image),d);await s.parse();Object.assign(tex,s.textures)}catch(e){console.warn('Sheet fail:',n,e)}}
}

function buildScene(){scene=new PIXI.Container();scene.sortableChildren=true;app.stage.addChild(scene);rebuildLanes();buildChicken();resetChicken()}

function rebuildLanes(){
  if(lanesC){scene.removeChild(lanesC);lanesC.destroy({children:true})}
  lanes=[];lanesC=new PIXI.Container();lanesC.zIndex=1;scene.addChild(lanesC);
  const n=DIFF[diff].lanes,mt=multTable(diff);
  lanesC.addChild(mkStartArea());
  for(let i=0;i<n;i++){const l=mkLane(i,mt[i]);l.x=START_W+i*LANE_W;lanesC.addChild(l);lanes.push(l)}
  const ea=mkEndArea();ea.x=START_W+n*LANE_W;lanesC.addChild(ea);
}

function mkStartArea(){
  const c=new PIXI.Container(),bg=new PIXI.Graphics();bg.beginFill(0x1a2040).drawRect(0,0,START_W,2000).endFill();c.addChild(bg);
  if(tex['top-curb.png']){const cb=new PIXI.Sprite(tex['top-curb.png']);cb.x=START_W-18;cb.y=0;cb.height=2000;c.addChild(cb)}
  if(tex['top-bench.png']){const b=new PIXI.Sprite(tex['top-bench.png']);b.anchor.set(.5);b.x=START_W/2-20;b.y=100;b.scale.set(.6);c.addChild(b)}
  if(tex['lamp.png']){const l=new PIXI.Sprite(tex['lamp.png']);l.anchor.set(.5);l.x=START_W/2+10;l.y=50;l.scale.set(.8);c.addChild(l)}
  if(tex['lamp-light.png']){const ll=new PIXI.Sprite(tex['lamp-light.png']);ll.anchor.set(.5,0);ll.x=START_W/2+10;ll.y=55;ll.scale.set(.5);ll.alpha=.4;c.addChild(ll)}
  if(tex['side-grate.png']){for(let y=200;y<800;y+=150){const g=new PIXI.Sprite(tex['side-grate.png']);g.anchor.set(.5);g.x=START_W/2;g.y=y;g.scale.set(.5);c.addChild(g)}}
  if(tex['chicken-sign.png']){const s=new PIXI.Sprite(tex['chicken-sign.png']);s.anchor.set(.5,1);s.x=START_W/2;s.y=380;s.scale.set(.5);c.addChild(s)}
  return c;
}

function mkLane(idx,multiplier){
  const c=new PIXI.Container();c.sortableChildren=true;c.idx=idx;
  const road=new PIXI.Graphics();road.beginFill(0x0c1020).drawRect(0,0,LANE_W,2000).endFill();c.addChild(road);
  const rl=new PIXI.Graphics();rl.beginFill(0x2a3055);for(let y=10;y<2000;y+=60)rl.drawRect(LANE_W-3,y,3,30);rl.endFill();c.addChild(rl);
  const tc=new PIXI.Container();tc.zIndex=5;
  let tile;
  if(tex['base-cover-tile.png']){tile=new PIXI.Sprite(tex['base-cover-tile.png']);tile.anchor.set(.5);tile.scale.set(.5)}
  else{tile=new PIXI.Graphics();tile.beginFill(0x262c52).drawRoundedRect(-65,-60,130,120,12).endFill()}
  tile.x=LANE_W/2;tc.addChild(tile);
  const mt=new PIXI.Text(multiplier.toFixed(2)+'x',{fontFamily:'Literata,Georgia,serif',fontSize:14,fontWeight:'700',fill:'#B9C0E5',stroke:'#0C0F20',strokeThickness:2,align:'center',dropShadow:true,dropShadowColor:'#0C0F20',dropShadowBlur:3,dropShadowAlpha:.4,dropShadowDistance:0});
  mt.anchor.set(.5);mt.x=LANE_W/2;mt.y=36;tc.addChild(mt);c.addChild(tc);
  const sh=new PIXI.Graphics();sh.beginFill(0x7339fa,.15).drawEllipse(LANE_W/2,60,50,12).endFill();sh.visible=false;tc.addChild(sh);
  const bc=new PIXI.Container();bc.zIndex=10;bc.visible=false;c.addChild(bc);
  c.tc=tc;c.tile=tile;c.mt=mt;c.sh=sh;c.bc=bc;
  tc.eventMode='static';tc.cursor='pointer';
  tc.on('pointerover',()=>{if(state==='playing'&&idx===round&&!animating){sh.visible=true;gsap.to(tile.scale||tile,{x:.53,y:.53,duration:.1})}});
  tc.on('pointerout',()=>{sh.visible=false;if(tile.scale)gsap.to(tile.scale,{x:.5,y:.5,duration:.1})});
  tc.on('pointerdown',()=>{if(state==='playing'&&idx===round&&!animating)crossLane()});
  return c;
}

function mkEndArea(){
  const c=new PIXI.Container(),bg=new PIXI.Graphics();bg.beginFill(0x1a2040).drawRect(0,0,END_W,2000).endFill();c.addChild(bg);
  if(tex['bottom-curb.png']){const cb=new PIXI.Sprite(tex['bottom-curb.png']);cb.y=0;cb.height=2000;c.addChild(cb)}
  const flag=new PIXI.Text('üèÅ',{fontSize:40});flag.anchor.set(.5);flag.x=END_W/2;flag.y=200;c.addChild(flag);return c;
}

function buildChicken(){
  if(chicken){scene.removeChild(chicken);chicken.destroy({children:true})}
  parts={};chicken=new PIXI.Container();chicken.sortableChildren=true;chicken.zIndex=50;scene.addChild(chicken);
  const body=new PIXI.Container();body.zIndex=2;chicken.addChild(body);parts.body=body;
  const legsC=new PIXI.Container();legsC.zIndex=-1;chicken.addChild(legsC);parts.legs=legsC;
  const ll=mkSpr('chicken-leg.png',.5,.11);ll.x=-15;ll.y=170;legsC.addChild(ll);parts.ll=ll;
  const rl=mkSpr('chicken-leg.png',.5,.17);rl.x=110;rl.y=170;legsC.addChild(rl);parts.rl=rl;
  const torso=mkSpr('chicken-torso.png',.5,.5);torso.zIndex=2;body.addChild(torso);parts.torso=torso;
  const tail=mkSpr('chicken-tail.png',.8,.5);tail.zIndex=4;body.addChild(tail);parts.tail=tail;
  const wing=mkSpr('chicken-wing.png',.7,0);wing.x=45;wing.y=-100;wing.zIndex=3;body.addChild(wing);parts.wing=wing;
  const head=new PIXI.Container();head.x=150;head.y=-100;head.zIndex=3;body.addChild(head);parts.head=head;
  const neck=mkSpr('chicken-neck.png',.5,.5);neck.rotation=7*Math.PI/180;head.addChild(neck);parts.neck=neck;
  const face=mkSpr('default.png',.5,.5);face.x=65;face.y=-50;head.addChild(face);parts.face=face;
  const rh=mkSpr('chicken-red-head.png',.5,.5);rh.x=10;rh.y=-175;rh.zIndex=-1;head.addChild(rh);parts.rh=rh;
  chicken.scale.set(CHK_SCALE);
}

function mkSpr(name,ax,ay){if(tex[name]){const s=new PIXI.Sprite(tex[name]);s.anchor.set(ax||.5,ay||.5);return s}const g=new PIXI.Graphics();g.beginFill(0xff6600).drawCircle(0,0,20).endFill();return g}
function setFace(n){if(tex[n]&&parts.face)parts.face.texture=tex[n]}

function resetChicken(){
  if(!chicken)return;chicken.x=START_W/2-10;chicken.y=app.screen.height/2+30;chicken.alpha=1;chicken.scale.set(CHK_SCALE);
  if(parts.body){parts.body.rotation=0;parts.body.y=0}
  if(parts.wing)parts.wing.rotation=0;if(parts.tail)parts.tail.rotation=0;
  if(parts.ll)parts.ll.rotation=0;if(parts.rl)parts.rl.rotation=0;setFace('default.png');
}

function layout(){
  if(!scene||!lanesC)return;const cy=app.screen.height/2;
  lanes.forEach(l=>{if(l.tc)l.tc.y=cy-30});if(state==='idle')resetChicken();
}
function panTo(idx,dur=.35){const tx=START_W+idx*LANE_W+LANE_W/2,cx=app.screen.width/2;gsap.to(scene,{x:Math.min(0,cx-tx),duration:dur,ease:'power2.inOut'})}

let trafficIv=null;
function startTraffic(){stopTraffic();trafficIv=setInterval(spawnCar,1800+Math.random()*2200)}
function stopTraffic(){if(trafficIv)clearInterval(trafficIv);trafficIv=null}
function spawnCar(){
  if(vehicles.length>=4||Math.random()>.8)return;const n=DIFF[diff].lanes;
  const lo=Math.max(0,round-2),hi=Math.min(n-1,round+6);if(lo>hi)return;
  const li=lo+Math.floor(Math.random()*(hi-lo+1));if(li>=lanes.length)return;const lane=lanes[li];
  const r=Math.random();let tn,sc;
  if(r<.5){tn=Math.random()<.5?'car-a.png':'taxi-a.png';sc=.25}
  else if(r<.9){tn=Math.random()<.5?'truck-b.png':'pick-truck-b.png';sc=.2}
  else{tn='police-a.png';sc=.25}
  const v=mkSpr(tn,.5,.5);v.scale.set(sc);v.zIndex=3;v.x=LANE_W/2;
  const down=Math.random()<.5;v.y=down?-200:app.screen.height+200;if(!down)v.rotation=Math.PI;
  lane.addChild(v);vehicles.push(v);
  if(tex['head-lights.png']){const hl=new PIXI.Sprite(tex['head-lights.png']);hl.anchor.set(.5);hl.alpha=.15;hl.scale.set(.35);v.addChild(hl)}
  const ty=down?app.screen.height+200:-200;play(['tc1q','tc2q'][Math.floor(Math.random()*2)]);
  gsap.to(v,{y:ty,duration:.7+Math.random()*.3,ease:'none',onComplete:()=>{lane.removeChild(v);v.destroy();const i=vehicles.indexOf(v);if(i>=0)vehicles.splice(i,1)}});
}

let idleTl=null;
function startIdle(){stopIdle();if(!parts.body)return;idleTl=gsap.timeline({repeat:-1,yoyo:true});idleTl.to(parts.body,{rotation:.04,y:'-=4',duration:1.8,ease:'sine.inOut'});gsap.to(parts.tail,{rotation:.2,duration:.6,repeat:-1,yoyo:true,ease:'sine.inOut'})}
function stopIdle(){if(idleTl){idleTl.kill();idleTl=null}gsap.killTweensOf(parts.tail);gsap.killTweensOf(parts.body)}

function jumpTo(fromX,toX,cy,cb){
  stopIdle();animating=true;setFace('angry.png');play('chirp');
  const tl=gsap.timeline({onComplete:()=>{setFace('default.png');startIdle();animating=false;if(cb)cb()}});
  tl.to(parts.body,{rotation:.35,y:'+=25',duration:.1,ease:'power2.in'});
  const mx=(fromX+toX)/2,my=cy-100;
  tl.to(chicken,{duration:.2,ease:'power2.out',motionPath:{path:[{x:fromX,y:cy+30},{x:mx,y:my},{x:toX,y:cy+30}],curviness:1.5}},'<0.05');
  tl.to(parts.body,{rotation:-.35,y:'-=30',duration:.15,ease:'power1.out'},'<');
  tl.to(parts.ll,{rotation:-.25,duration:.1},'<');tl.to(parts.rl,{rotation:.25,duration:.1},'<');
  tl.to(parts.wing,{rotation:-1.5,duration:.12,ease:'power2.out'},'<');
  tl.to(parts.body,{rotation:0,y:0,duration:.1,ease:'bounce.out'});
  tl.to(parts.ll,{rotation:0,duration:.08},'<');tl.to(parts.rl,{rotation:0,duration:.08},'<');
  tl.to(parts.wing,{rotation:0,duration:.1},'<');tl.to(chicken,{y:cy+30,duration:.12,ease:'bounce.out'},'<');
}

function showBarrier(i){
  if(i>=lanes.length)return;const l=lanes[i],bc=l.bc;bc.removeChildren();bc.visible=true;const cy=app.screen.height/2;
  if(tex['no-crack-barrier.png']){const b=new PIXI.Sprite(tex['no-crack-barrier.png']);b.anchor.set(.5,1);b.x=LANE_W/2;b.scale.set(.25);b.rotation=(Math.random()-.5)*.7;bc.addChild(b);b.y=cy-300;b.alpha=0;gsap.to(b,{y:cy-60,alpha:1,duration:.3,ease:'bounce.out'});play('bi'+Math.floor(Math.random()*3));if(tex['blocker-shadow.png']){const s=new PIXI.Sprite(tex['blocker-shadow.png']);s.anchor.set(.5);s.x=LANE_W/2;s.y=cy+20;s.scale.set(.25);s.alpha=.5;bc.addChild(s)}setTimeout(()=>{for(let ci=1;ci<=Math.floor(Math.random()*3)+1;ci++){if(tex['crack-'+ci+'.png']){const cr=new PIXI.Sprite(tex['crack-'+ci+'.png']);cr.anchor.set(.5);cr.x=LANE_W/2+(Math.random()-.5)*60;cr.y=cy-80+Math.random()*30;cr.scale.set(.3);cr.rotation=Math.random()*.5;bc.addChild(cr)}}},200)}
  if(tex['won-cover-tile.png']&&l.tile instanceof PIXI.Sprite)setTimeout(()=>{l.tile.texture=tex['won-cover-tile.png']},100);
  if(l.mt)l.mt.style.fill='#7DD934';
}

function deathCar(){
  setFace('scared-2.png');play(Math.random()<.5?'carHit1':'carHit2');
  if(round>=lanes.length)return;const lane=lanes[round],cy=app.screen.height/2;
  const ct=Math.random()<.5?'car-a.png':'taxi-a.png';const car=mkSpr(ct,.5,.5);car.scale.set(.3);car.zIndex=100;car.x=LANE_W/2;car.y=-200;lane.addChild(car);
  if(tex['head-lights.png']){const hl=new PIXI.Sprite(tex['head-lights.png']);hl.anchor.set(.5);hl.alpha=.3;hl.scale.set(.4);car.addChild(hl)}
  gsap.to(car,{y:cy+30,duration:.4,ease:'none',onComplete:()=>{
    gsap.to(chicken,{alpha:0,duration:.08});gsap.to(chicken.scale,{x:.06,duration:.08});
    setTimeout(()=>{if(tex['dead-chicken.png']){const dc=new PIXI.Sprite(tex['dead-chicken.png']);dc.anchor.set(.5);dc.x=LANE_W/2;dc.y=cy+20;dc.scale.set(0);dc.zIndex=30;lane.addChild(dc);gsap.to(dc.scale,{x:.08,y:.08,duration:.3,ease:'back.out(1.6)'})}play('lose')},200);
    if(tex['tire-tracks.png']){const tt=new PIXI.Sprite(tex['tire-tracks.png']);tt.anchor.set(.5);tt.x=LANE_W/2;tt.y=cy+30;tt.scale.set(.15);tt.alpha=.7;tt.zIndex=2;lane.addChild(tt)}
    gsap.to(car,{y:app.screen.height+300,duration:.5,ease:'none',onComplete:()=>{lane.removeChild(car);car.destroy()}});
  }});
}

function deathSewer(){
  setFace('scared-2.png');play('grate');if(round>=lanes.length)return;
  const lane=lanes[round],cy=app.screen.height/2;
  if(tex['open-man-hole.png']&&lane.tile instanceof PIXI.Sprite)lane.tile.texture=tex['open-man-hole.png'];
  if(tex['glowing-eyes.png']){const ey=new PIXI.Sprite(tex['glowing-eyes.png']);ey.anchor.set(.5);ey.x=LANE_W/2;ey.y=cy+10;ey.scale.set(.5);ey.alpha=0;ey.zIndex=4;lane.addChild(ey);gsap.to(ey,{alpha:1,duration:.3,delay:.1})}
  if(tex['fingers.png']){const fi=new PIXI.Sprite(tex['fingers.png']);fi.anchor.set(.5);fi.x=LANE_W/2-20;fi.y=cy-20;fi.scale.set(.5);fi.alpha=0;fi.zIndex=4;lane.addChild(fi);gsap.to(fi,{alpha:1,duration:.2,delay:.2})}
  setTimeout(()=>{gsap.to(chicken,{y:cy+180,alpha:0,duration:.25,ease:'power2.in'});gsap.to(chicken.scale,{x:.08,y:.08,duration:.25,ease:'power2.in'});setTimeout(()=>{if(tex['base-cover-tile.png']&&lane.tile instanceof PIXI.Sprite)lane.tile.texture=tex['base-cover-tile.png'];play('lose');if(tex['ghost-body.png']){const gh=new PIXI.Sprite(tex['ghost-body.png']);gh.anchor.set(.5);gh.x=LANE_W/2;gh.y=cy-40;gh.scale.set(0);gh.alpha=.7;gh.zIndex=30;lane.addChild(gh);gsap.to(gh.scale,{x:.1,y:.1,duration:.4,ease:'back.out(1.6)'});gsap.to(gh,{y:cy-50,duration:2,repeat:-1,yoyo:true,ease:'sine.inOut'})}},400)},500);
}

function animWin(){
  setFace('laugh-2.png');play('win');const tl=gsap.timeline({repeat:3});
  tl.to(chicken,{y:'-=50',duration:.15,ease:'power2.out'});tl.to(chicken,{y:'+=50',duration:.15,ease:'bounce.out'});
  gsap.to(parts.tail,{rotation:.35,duration:.2,repeat:8,yoyo:true,ease:'sine.inOut'});
  gsap.to(parts.wing,{rotation:-1.2,duration:.25,repeat:4,yoyo:true,ease:'power2.inOut'});
}

function onCross(){
  if(state==='idle')startGame();
  else if(state==='playing')crossLane();
}

function startGame(){
  const bv=parseFloat(document.getElementById('betAmount').value);
  if(isNaN(bv)||bv<=0)return;if(bv>balance){alert('Insufficient balance!');return}
  gsap.killTweensOf('*');stopIdle();stopTraffic();hideWin();animating=false;
  vehicles.forEach(v=>{try{v.parent?.removeChild(v);v.destroy()}catch(e){}});vehicles.length=0;
  bet=bv;balance-=bet;round=0;mult=0;results=genResults(diff);
  rebuildLanes();layout();buildChicken();resetChicken();scene.x=0;
  state='playing';startIdle();startTraffic();updateUI();hlNext();play('chirp');
}

function crossLane(){
  if(state!=='playing'||animating)return;if(round>=results.length)return;
  let safe=results[round];
  if(!safe&&cheatCharges>0){safe=true;results[round]=true;cheatCharges--}
  const cy=app.screen.height/2;
  const fromX=round===0?START_W/2-10:START_W+(round-1)*LANE_W+LANE_W/2;
  const toX=START_W+round*LANE_W+LANE_W/2;
  document.getElementById('crossBtn').disabled=true;
  jumpTo(fromX,toX,cy,()=>{
    if(safe){
      round++;mult=calcMult(round,DIFF[diff].factor);showBarrier(round-1);panTo(round);updateUI();
      document.getElementById('crossBtn').disabled=false;
      if(round>=DIFF[diff].lanes){state='won';stopTraffic();const w=bet*mult;balance+=w;showWin(w,mult);animWin();updateUI();setTimeout(()=>{hideWin();state='idle';animating=false;updateUI()},2500)}
      else{hlNext()}
    }else{
      state='dead';stopTraffic();Math.random()<.5?deathCar():deathSewer();updateUI();
      setTimeout(()=>{state='idle';animating=false;stopIdle();stopTraffic();updateUI()},2500);
    }
  });
}

function cashOut(){
  if(state!=='playing'||round===0)return;state='cashedOut';stopTraffic();
  mult=calcMult(round,DIFF[diff].factor);const w=bet*mult;balance+=w;
  showWin(w,mult);setFace('happy-2.png');play('win');
  gsap.to(parts.tail,{rotation:.3,duration:.3,repeat:4,yoyo:true});updateUI();
  setTimeout(()=>{hideWin();state='idle';animating=false;updateUI()},2000);
}

function hlNext(){
  if(round>=lanes.length)return;const l=lanes[round];
  if(tex['active-cover-tile.png']&&l.tile instanceof PIXI.Sprite)l.tile.texture=tex['active-cover-tile.png'];
  gsap.to(l.tc,{pixi:{scale:1.05},duration:.6,repeat:-1,yoyo:true,ease:'sine.inOut'});
}

function updateUI(){
  const crossBtn=document.getElementById('crossBtn');
  const cashoutBtn=document.getElementById('cashoutBtn');
  const betBtn=document.getElementById('betBtn');
  const infoRow=document.getElementById('infoRow');
  const infoLabel=document.getElementById('infoLabel');
  const infoVal=document.getElementById('infoVal');
  const rd=document.getElementById('roundDisplay');
  const nm=document.getElementById('nextMultDisplay');
  const n=DIFF[diff].lanes,f=DIFF[diff].factor;
  rd.textContent=round+' / '+n;

  if(state==='idle'){
    crossBtn.style.display='none';cashoutBtn.style.display='none';betBtn.style.display='';
    betBtn.disabled=false;
    infoLabel.textContent='Enter Bet Amount For Real Play';
    infoVal.textContent=calcMult(1,f).toFixed(2)+'x';infoVal.className='val zero';
    nm.textContent=calcMult(1,f).toFixed(2)+'x';
  }else if(state==='playing'){
    betBtn.style.display='none';crossBtn.style.display='';
    cashoutBtn.style.display=round>0?'':'none';
    crossBtn.disabled=false;cashoutBtn.disabled=false;
    if(round===0){infoLabel.textContent='Enter Bet Amount For Real Play';infoVal.textContent=calcMult(1,f).toFixed(2)+'x';infoVal.className='val zero'}
    else{infoLabel.textContent='$'+(bet*mult).toFixed(2);infoVal.textContent=mult.toFixed(2)+'x';infoVal.className='val'}
    nm.textContent=round<n?calcMult(round+1,f).toFixed(2)+'x':'‚Äî';
  }else{
    crossBtn.style.display='none';cashoutBtn.style.display='none';betBtn.style.display='';
    betBtn.disabled=true;
    if(state==='dead'){infoLabel.textContent='Enter Bet Amount For Real Play';infoVal.textContent='0.00x';infoVal.className='val zero'}
    else{infoLabel.textContent='$'+(bet*mult).toFixed(2);infoVal.textContent=mult.toFixed(2)+'x';infoVal.className='val'}
    nm.textContent=calcMult(1,f).toFixed(2)+'x';
  }
}

function multBet(f){const inp=document.getElementById('betAmount');inp.value=Math.max(.01,(parseFloat(inp.value)||1)*f).toFixed(2)}
function showWin(amt,m){document.getElementById('winAmount').textContent='$'+amt.toLocaleString('en-US',{minimumFractionDigits:2,maximumFractionDigits:2});document.getElementById('winMult').textContent=m.toFixed(2)+'x';document.getElementById('winOverlay').classList.add('show')}
function hideWin(){document.getElementById('winOverlay').classList.remove('show')}

function toggleDifficulty(){document.getElementById('diffDropdown').classList.toggle('show');document.getElementById('diffArrow').classList.toggle('open')}
function setDifficulty(d){
  if(state!=='idle')return;diff=d;document.getElementById('diffLabel').textContent=DIFF[d].label;
  document.querySelectorAll('.diff-option').forEach(el=>el.classList.toggle('active',el.dataset.diff===d));
  document.getElementById('diffDropdown').classList.remove('show');document.getElementById('diffArrow').classList.remove('open');
  rebuildLanes();layout();buildChicken();resetChicken();updateUI();
}
document.addEventListener('click',e=>{if(!e.target.closest('.diff-select')){document.getElementById('diffDropdown').classList.remove('show');document.getElementById('diffArrow').classList.remove('open')}});

function showFairness(){cheatCharges++;const fb=document.querySelector('.fair-play-btn');fb.style.color='#7DD934';setTimeout(()=>{fb.style.color=''},200)}

function toggleSound(){
  soundEnabled=!soundEnabled;const btn=document.getElementById('soundBtn');
  btn.innerHTML=soundEnabled?'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"/><path d="M19.07 4.93a10 10 0 010 14.14M15.54 8.46a5 5 0 010 7.07"/></svg>':'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"/><line x1="23" y1="9" x2="17" y2="15"/><line x1="17" y1="9" x2="23" y2="15"/></svg>';
  Howler.mute(!soundEnabled);
}
function toggleFullscreen(){if(!document.fullscreenElement)document.documentElement.requestFullscreen().catch(()=>{});else document.exitFullscreen()}

document.addEventListener('keydown',e=>{
  if(e.key===' '||e.key==='Enter'){e.preventDefault();if(state==='playing'&&!animating)crossLane();else if(state==='idle')startGame();return}
  if((e.key==='c'||e.key==='C'||e.key==='Escape')&&state==='playing'&&round>0)cashOut();
});

window.addEventListener('DOMContentLoaded',()=>{init();updateUI()});
</script>
</body>
</html>